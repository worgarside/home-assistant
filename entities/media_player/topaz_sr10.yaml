---
# yamllint disable rule:line-length

platform: universal

id: media_player.topaz_sr10

unique_id: media_player.topaz_sr10

name: Topaz SR10

device_class: speaker

children:
  - media_player.spotify_will

active_child_template: "{{ states('sensor.topaz_sr10_active_child') }}"

state_template: >-
  {% if has_value('sensor.topaz_sr10_active_child') %}
    {{ states(states('sensor.topaz_sr10_active_child')) }}
  {%
    elif state_attr('sensor.topaz_sr10_active_child', 'current_source') not in (
      None,
      "unknown",
      "unavailable"
    )
  %}
    playing
  {% elif is_state("switch.office_amp", "off") %}
    off
  {% else %}
    on
  {% endif %}

attributes:
  source: input_select.topaz_sr10_source
  source_list: sensor.topaz_sr10_active_child|source_list
  volume_level: sensor.topaz_sr10_active_child|volume_level

commands:
  turn_on:
    service: switch.turn_on
    target:
      entity_id: switch.office_amp

  turn_off:
    service: script.run_dynamic_script
    data:
      script_id: script.topaz_sr10_turn_off
      actions:
        - alias: Stop media if applicable
          if:
            - not:
                - condition: state
                  entity_id: sensor.topaz_sr10_active_child
                  state:
                    - none
                    - None
                    - "null"
                    - unavailable
                    - unknown

          then:
            - service: media_player.media_stop
              target:
                entity_id: media_player.topaz_sr10

        - service: switch.turn_off
          target:
            entity_id: switch.office_amp

  select_source:
    service: script.run_dynamic_script
    data:
      script_id: script.topaz_sr10_select_source
      actions:
        - service: script.ir_blaster_issue_command
          data:
            code: >-
              {%
                set source_code_mapping = {
                  "CD": "B0AjSxFcAiICQAPAAUALQAMDIgJ2BkADAFygB8ALwA8DXAIiAoADQAtAA0APAnYGIiADA1wCIgJAA8ABgAvgARcEXAJ2BiIgA0AHEVwCQ5tAI6MIXAL//0AjowgiAg==",
                  "FM": "BzEjTBFmAjMCQAPAAeABCwF2BuAVA4ABQC9AA4ABwDNAAUALQAFAB8ADgAEBZgJADwEzAoAHB2mbMSOxCDMC",
                  "AM": "BkUjQxFjAjNgAUAHQAPAAQRjAnIGM+AUA4ABgCcEMwJjAjMgAcAzAzMCYwJAC8ABQAtAAwQzAmMCMyABAXIGwAcJMwJUm0UjoAhjAg==",
                  "BD/DVD": "Bz0jTBFhAjQCQAPAAcALBGECcQY04AYD4AMTAmECNKABAXEG4AcDwBtAB0ADwAHgAQsBcQbgAQMPSJs9I5UINAL//z0jlQg0Ag==",
                  "MP3/Aux": "BUwjQhEsAoABAV4CgANAAUALAywCeQbgCwMAXuAAFwMsAl4CgANAAQReAnkGLOAAAwEsAkAPAV4CgAcBLAJAAwEsAkAPgAEBeQaACwt5BiwCVJtMI6IILAI=",
                  "Phono": "BjYjahFoAidgAUAHQANAAUAHBGgCdAYnoAPgAwvAEwUnAicCaAJAA8ALAXQGQAMAJ2AHACcgAUALgAEBaAKACwJoAiegAQF0BoALC3QGaAJTmzYjpQgnAg==",
                }
              %}

              {{ source_code_mapping[source] }}

        - service: input_select.select_option
          target:
            entity_id: input_select.topaz_sr10_source
          data:
            option: "{{ source }}"

  volume_up:
    service: script.run_dynamic_script
    data:
      script_id: script.topaz_sr10_volume_up
      actions:
        - service: input_number.increment
          target:
            entity_id: input_number.topaz_sr10_volume_level

        - service: script.ir_blaster_issue_command
          data:
            code: BxojaBFdAiMCwANAAcALBF0CewYjoANAC0ADQA/ABwUjAiMCXQJAAwR7Bl0CIyABAXsG4AEDASMCQBPgAQNAG4ABAV0CQANAD8ADB4ObGiOYCCMC

  volume_down:
    service: script.run_dynamic_script
    data:
      script_id: script.topaz_sr10_volume_up
      actions:
        - service: input_number.decrement
          target:
            entity_id: input_number.topaz_sr10_volume_level

        - service: script.ir_blaster_issue_command
          data:
            code: BjQjURFhAjLgAAHgBQsCfwYy4AoD4AEXBDICYQIyoAEBfwbgBQNAAUATQAHABwEyAkAvQAMBMgLAE0AHCU+bNCOiCDIC///gAgcCCDIC

  volume_set:
    service: script.topaz_sr10_volume_set
    data:
      volume_level: "{{ volume_level }}"

  volume_mute:
    service: script.ir_blaster_issue_command
    data:
      code: CRojYhEmAiYCZgKAA0AB4AELAW0GQAMAZuACB8ALQBcGJgImAmYCJmABQAfgBwNAAYATQCuAA+ANCw9NmxojmghmAv//GiOaCGYC

  # media_play_pause:
  #   if: "{{ is_state('sensor.topaz_sr10_active_child', 'media_player.spotify_will') }}"
  #   then:
  #     - service: media_player.media_play_pause
  #       target:
  #         entity_id: media_player.spotify_will

  # media_play:
  #   service: pyscript.yas_209_play

  # media_pause:
  #   service: pyscript.yas_209_pause

  # media_stop:
  #   service: pyscript.yas_209_stop

  # media_next_track:
  #   service: pyscript.yas_209_next_track

  # media_previous_track:
  #   service: pyscript.yas_209_previous_track
