---
platform: sql

name: Will | Mood Streak

unique_id: will_mood_streak

icon: mdi:fire

query: >-
  WITH daily_last_states AS (
    SELECT
      DATE(to_timestamp(states.last_updated_ts)) as check_date,
      states.state,
      states.last_updated_ts,
      ROW_NUMBER() OVER (
        PARTITION BY DATE(to_timestamp(states.last_updated_ts))
        ORDER BY states.last_updated_ts DESC
      ) as rn
    FROM states
    INNER JOIN states_meta ON states.metadata_id = states_meta.metadata_id
    WHERE states_meta.entity_id = 'input_select.will_mood_today'
      AND states.last_updated_ts >= EXTRACT(EPOCH FROM (CURRENT_DATE - INTERVAL '365 days'))
      AND DATE(to_timestamp(states.last_updated_ts)) < CURRENT_DATE
  ),
  valid_dates AS (
    SELECT DISTINCT check_date
    FROM daily_last_states
    WHERE rn = 1
      AND state IN ('Very Low', 'Low', 'Okay', 'Good', 'Great')
  ),
  ordered_dates AS (
    SELECT
      check_date,
      (CURRENT_DATE - 1) - check_date as days_ago,
      ROW_NUMBER() OVER (ORDER BY check_date DESC) as rn
    FROM valid_dates
    ORDER BY check_date DESC
  ),
  consecutive_groups AS (
    SELECT
      check_date,
      days_ago,
      rn,
      days_ago - rn + 1 as grp
    FROM ordered_dates
  )
  SELECT COUNT(*)::integer as streak
  FROM consecutive_groups
  WHERE grp = (SELECT grp FROM consecutive_groups WHERE days_ago = 0 LIMIT 1)

column: streak
