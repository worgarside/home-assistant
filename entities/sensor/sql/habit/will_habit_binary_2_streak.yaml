---
platform: sql

name: Will | Habit Binary 2 Streak

unique_id: will_habit_binary_2_streak

icon: mdi:fire

query: >-
  WITH min_days_per_week AS (
    SELECT COALESCE(
      (SELECT (state::numeric)::integer
       FROM states
       INNER JOIN states_meta ON states.metadata_id = states_meta.metadata_id
       WHERE states_meta.entity_id = 'input_number.will_habit_binary_2_streak_min_days_per_week'
       ORDER BY states.last_updated_ts DESC
       LIMIT 1),
      7
    ) as min_days
  ),
  daily_last_states AS (
    SELECT
      DATE(to_timestamp(states.last_updated_ts)) as check_date,
      states.state,
      states.last_updated_ts,
      ROW_NUMBER() OVER (
          PARTITION BY DATE(to_timestamp(states.last_updated_ts))
          ORDER BY states.last_updated_ts DESC
      ) as rn
    FROM states
    INNER JOIN states_meta ON states.metadata_id = states_meta.metadata_id
    WHERE states_meta.entity_id = 'input_boolean.will_habit_binary_2'
      AND states.last_updated_ts >= EXTRACT(EPOCH FROM (CURRENT_DATE - INTERVAL '365 days'))
      AND DATE(to_timestamp(states.last_updated_ts)) < CURRENT_DATE
  ),
  valid_dates AS (
    SELECT DISTINCT check_date
    FROM daily_last_states
    WHERE rn = 1
      AND state = 'on'
  ),
  week_groups AS (
    SELECT
      DATE_TRUNC('week', check_date - INTERVAL '1 day') + INTERVAL '1 day' as week_start,
      COUNT(*) as days_count
    FROM valid_dates
    GROUP BY DATE_TRUNC('week', check_date - INTERVAL '1 day') + INTERVAL '1 day'
  ),
  yesterday_week_start AS (
    SELECT DATE_TRUNC('week', (CURRENT_DATE - 1) - INTERVAL '1 day') + INTERVAL '1 day' as week_start
  ),
  valid_weeks AS (
    SELECT
      wg.week_start,
      wg.days_count,
      EXTRACT(EPOCH FROM ((CURRENT_DATE - 1) - wg.week_start)) / 86400 as days_ago_week_start
    FROM week_groups wg
    CROSS JOIN min_days_per_week mdpw
    CROSS JOIN yesterday_week_start yws
    WHERE wg.days_count >= mdpw.min_days
       OR (wg.week_start = yws.week_start AND wg.days_count > 0)
  ),
  ordered_weeks AS (
    SELECT
      vw.week_start,
      vw.days_count,
      vw.days_ago_week_start,
      ROW_NUMBER() OVER (ORDER BY vw.week_start DESC) as rn,
      (EXTRACT(EPOCH FROM (
        vw.week_start - LAG(vw.week_start, 1) OVER (ORDER BY vw.week_start DESC)
      )) / 86400)::integer as days_since_prev_week
    FROM valid_weeks vw
    CROSS JOIN yesterday_week_start yws
    WHERE vw.week_start <= yws.week_start
  ),
  consecutive_week_groups AS (
    SELECT
      week_start,
      days_count,
      days_ago_week_start,
      rn,
      SUM(CASE WHEN days_since_prev_week IS NULL OR days_since_prev_week = 7 THEN 0 ELSE 1 END)
        OVER (ORDER BY week_start DESC) as grp
    FROM ordered_weeks
  ),
  current_streak_weeks AS (
    SELECT week_start, days_count
    FROM consecutive_week_groups
    WHERE grp = (SELECT grp FROM consecutive_week_groups ORDER BY week_start DESC LIMIT 1)
  )
  SELECT COALESCE(SUM(days_count)::integer, 0) as streak
  FROM current_streak_weeks

column: streak
