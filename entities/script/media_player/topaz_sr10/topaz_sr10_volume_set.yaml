---
description: Set the volume of the Topaz SR10 to a specific value

mode: queued  # Otherwise the true value will be lost on script restart/ignore

max: 50

fields:
  volume_level:
    description: The volume level to set the Topaz SR10 to; 0.0 - 1.0
    required: true

sequence:
  - if: "{{ volume_level | default(-999) | float(-999) == -999 }}"

    then:
      - service: script.log_exception
        data:
          calling_entity: script.topaz_sr10_volume_set
          message: "Invalid `volume_level` value: `{{ volume_level | default('<undefined>') }}`"

      - stop: "Invalid `volume_level` value: `{{ volume_level | default('<undefined>') }}`"
        error: true

  - variables:
      initial_level: "{{ state_attr('media_player.topaz_sr10', 'volume_level') | float(0) }}"

      up_or_down: "{{ iif( initial_level | float > volume_level | float, 'down', 'up') }}"

      repeat_count: "{{ ( (initial_level | float - volume_level | float) | abs * 100 ) | int(0) }}"

  - repeat:
      count: "{{ repeat_count }}"
      sequence:
        - service: media_player.volume_{{ up_or_down }}
          target:
            entity_id: media_player.topaz_sr10
