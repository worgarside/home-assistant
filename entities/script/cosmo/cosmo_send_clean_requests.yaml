---
description: Send a notification asking to vacuum on behalf of Cosmo

mode: queued

max: 7

fields:
  room:
    description: The room to send the request for
    required: true

sequence:
  - wait_template: "{{ is_state('vacuum.cosmo', 'docked') }}"

    timeout:
      hours: 4

    continue_on_timeout: false

  - variables:
      time_difference: >-
        {% set clean = states('input_datetime.cosmo_last_lounge_clean') | default(0) %}

        {% if clean in (0, "unavailable", "unknown") %}
          0
        {% else %}
          {% set clean_ts = clean | as_timestamp %}
          {% set now_ts = now() | as_timestamp %}
          {{ max(0, now_ts - clean_ts) }}
        {% endif %}
      days: "{{ (time_difference // (24 * 3600)) }}"
      hours: "{{ (time_difference % (24 * 3600)) // 3600 }}"

  - alias: Conditionally send a request to Vic and Will
    repeat:
      for_each:
        - vic
        - will
      sequence:
        - if:
            or:
              - alias: Nobody home
                condition: state
                entity_id: zone.home
                state: 0

              - alias: "{{ repeat.item }} is at home"
                condition: state
                entity_id: person.{{ repeat.item }}
                state: home

          then:
            - service: script.notify_{{ repeat.item }}
              data:
                title: Cosmo wants to clean the lounge!

                message: >-
                  I haven't cleaned the lounge for

                  {% if days > 0 -%}
                    {{ days ~ ' day' ~ ('s' if days > 1 else '') }}
                    {% if hours > 0 %}
                      ,
                    {% endif %}
                  {% endif %}

                  {% if hours > 0 %}
                    {{ hours ~ ' hour' ~ ('s' if hours > 1 else '') }}
                  {% endif %}

                  . Please can I clean it?

                notification_id: cosmo_room_timed_out_lounge

                mobile_notification_icon: mdi:robot-vacuum

                actions:
                  - action: COSMO:CLEAN_NOW:LOUNGE
                    title: Clean now

                  - action: COSMO:CLEAN_LATER:LOUNGE
                    title: Remind me later

                  - action: COSMO:IGNORE:LOUNGE
                    title: Not today
