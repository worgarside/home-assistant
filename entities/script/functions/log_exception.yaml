---
alias: Log Exception

description: Log an exception, does not end the calling execution!

mode: parallel

fields:
  calling_entity:
    description: The entity that called this service
    required: true
    example: automation.do_something  # hacv disable: InvalidEntityConsumed
    selector:
      entity:

  message:
    description: The message to be logged
    required: true
    example: Something went wrong!
    selector:
      text:
        multiline: true

variables:
  entity_domain: "{{ calling_entity.split('.')[0] }}"
  entity_id: "{{ calling_entity.split('.')[1] }}"
  timestamp: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

sequence:
  - service: persistent_notification.create
    data:
      title: ⚠️ Error thrown by {{ entity_domain.replace('_', ' ').title() }}
      message: |
        Source:  [`{{ calling_entity }}`](/config/{{ entity_domain }}/trace/{{ entity_id }})
        Time:    `{{ timestamp }}`
        Message: {{ '`' + message + '`' if '\n' not in message else '\n' + message }}

  - service: system_log.write
    data:
      message: "{{ message }}"
      level: error
      logger: "{{ calling_entity }}"
