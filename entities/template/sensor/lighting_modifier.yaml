---
name: Lighting Modifier

unique_id: lighting_modifier

unit_of_measurement: "%"

icon: mdi:brightness-percent

state: >-
  {% set sun = states("sensor.sun_elevation") | float(0) %}
  {% set quiet_hours = states("binary_sensor.quiet_hours") | bool(false) %}
  {% set weekday = states("binary_sensor.weekday") | bool(false) %}
  {% set hour = states("sensor.current_hour") | int(12) %}
  {% set min_limit = states("input_number.lighting_modifier_minimum") | int(1) %}
  {% set max_limit = states("input_number.lighting_modifier_maximum") | int(100) %}

  {% set base_brightness =
    100 if sun >= 2 else
    60 if sun >= -1 else
    30 if sun >= -6 else
    10 if sun >= -12 else
    5 if sun >= -18 else
    1
  %}

  {% set base_brightness = min(base_brightness, 30) if hour < 7 else base_brightness %}
  {% set base_brightness = max(base_brightness, 30) if 12 <= hour < 22 else base_brightness %}
  {% set base_brightness = max(base_brightness, 10) if 12 <= hour < 23 else base_brightness %}

  {% if weekday and 9 <= hour < 18 %}
    {{ max(min_limit, min(100, max_limit)) }}
  {% elif weekday and 0 <= hour < 7 %}
    {{ max(min_limit, min(base_brightness, max_limit)) }}
  {% elif quiet_hours and sun >= 2 %}
    {{ max(min_limit, min(75, max_limit)) }}
  {% else %}
    {{ max(min_limit, min(base_brightness, max_limit)) }}
  {% endif %}
