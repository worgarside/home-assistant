---
name: Count Low Batteries
unique_id: count_low_batteries
state: "{{ this.attributes.entities | list | count }}"
icon_template: >
  {% set ns = namespace(total=0, count=0, average=0) %}
  {% for value in this.attributes.entities | map(attribute="state") | map("int") %}
    {% set ns.total = ns.total + value %}
    {% set ns.count = ns.count + 1 %}
    {% set ns.average = ns.total / ns.count %}
  {% endfor %}
  mdi:battery-{{ ns.average | round(-1) | int }}
unit_of_measurement: ""
attributes:
  entities: >
    {% set ns = namespace(low_batteries=[]) %}
    {%
      for s in states.sensor
      if (
        'battery' in s.entity_id and
        (
          s.entity_id is not match(
            "^sensor\..+_battery_(state|health|temperature|power)"
          )
        ) and
        states(s.entity_id) | int(default=100) <= 30
      )
    %}
      {% set ns.low_batteries = ns.low_batteries + [ s ] %}
    {% endfor %}
    {{ ns.low_batteries }}
