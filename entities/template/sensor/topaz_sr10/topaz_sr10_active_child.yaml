---
name: Topaz SR10 Active Child

unique_id: topaz_sr10_active_child

state: >-
  {% if is_state("switch.office_amp", "off") %}
    {{ None }}
  {%
    elif is_state_attr('media_player.topaz_sr10', 'source', "MP3/Aux") and (
      (
        is_state("sensor.wills_macbook_pro_active_audio_output", "FiiO USB DAC-E10") and
        is_state_attr(
          "media_player.spotify_will",
          "source",
          device_attr(device_id('sensor.wills_macbook_pro_active_audio_output'), 'name')
        )
      ) or (
        is_state("sensor.st_macbook_pro_active_audio_output", "FiiO USB DAC-E10") and
        is_state_attr(
          "media_player.spotify_will",
          "source",
          device_attr(device_id('sensor.st_macbook_pro_active_audio_output'), 'name')
        )
      )
    )
  %}
    media_player.spotify_will
  {% else %}
    unknown
  {% endif %}

attributes:
  current_source: >-
    {% if this.state == "media_player.spotify_will" %}
      Spotify ({{
        iif(is_state_attr("media_player.spotify_will", "source", "K3QFMW509D"), "Work", "Will's")
      }} MacBook Pro)
    {% elif is_state("sensor.wills_macbook_pro_active_audio_output", "FiiO USB DAC-E10") %}
      {{ device_attr(device_id('sensor.wills_macbook_pro_active_audio_output'), 'name') }}
    {% elif is_state("sensor.st_macbook_pro_active_audio_output", "FiiO USB DAC-E10") %}
      {{ device_attr(device_id('sensor.st_macbook_pro_active_audio_output'), 'name') }}
    {% else %}
      {{ this.state }}
    {% endif %}

  source_list: "{{ state_attr('input_select.topaz_sr10_source', 'options') }}"

  # Converted from -80db - 0db range to 0.00 - 1.00 value
  volume_level: >-
    {{
      iif(
        is_number(states('input_number.topaz_sr10_volume_level')),
        ((states('input_number.topaz_sr10_volume_level') | int + 80) / 80) | round(2),
        None
      )
    }}
