---
friendly_name: Central Heating

unique_id: central_heating

icon_template: >-
  {% if states('switch.central_heating') | bool(false) %}
    mdi:radiator
  {% else %}
    mdi:radiator-off
  {% endif %}

turn_on:
  - condition: state
    entity_id: switch.central_heating
    state: 'off'

  - if: >
      {{
        has_value('var.central_heating_last_action') and
        states('var.central_heating_last_action') and
        (as_timestamp(now()) - as_timestamp(states('var.central_heating_last_action'))) <= 10
      }}

    then:
      - delay:
          seconds: >-
            {{
              (as_timestamp(states('var.central_heating_last_action')) + 10) - as_timestamp(now())
            }}

  - service: var.set
    target:
      entity_id: var.central_heating_last_action
    data:
      value: "{{ now().isoformat() }}"

  - service: switch.toggle
    target:
      entity_id: switch.boiler_fingerbot_heating

  - wait_for_trigger:
      - trigger: state
        entity_id: switch.boiler_fingerbot_heating
        for:
          seconds: 2

  - service: switch.toggle
    target:
      entity_id: switch.boiler_fingerbot_heating

  - wait_for_trigger:
      - trigger: state
        entity_id: switch.boiler_fingerbot_heating
        for:
          seconds: 2

  - service: switch.toggle
    target:
      entity_id: switch.boiler_fingerbot_heating

turn_off:
  - condition: >-
      {{
        is_state('switch.central_heating', 'on') or
        is_state('binary_sensor.boiler_heating_led_sensor', 'on')
      }}

  - if: >
      {{
        has_value('var.central_heating_last_action') and
        states('var.central_heating_last_action') and
        (as_timestamp(now()) - as_timestamp(states('var.central_heating_last_action'))) <= 10
      }}

    then:
      - delay:
          seconds: >-
            {{
              (as_timestamp(states('var.central_heating_last_action')) + 10) - as_timestamp(now())
            }}

  - service: var.set
    target:
      entity_id: var.central_heating_last_action
    data:
      value: "{{ now().isoformat() }}"

  - repeat:
      while: "{{ is_state('binary_sensor.boiler_heating_led_sensor', 'on') and repeat.index < 10 }}"
      sequence:
        - service: switch.toggle
          target:
            entity_id: switch.boiler_fingerbot_heating
        - delay:
            seconds: 2
