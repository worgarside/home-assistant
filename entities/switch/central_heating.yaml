---
friendly_name: Central Heating

unique_id: central_heating

icon_template: >-
  {% if states('switch.central_heating') | bool(false) %}
    mdi:radiator
  {% else %}
    mdi:radiator-off
  {% endif %}

turn_on:
  - if: >
      {{
        not has_value('var.central_heating_last_action') or
        not states('var.central_heating_last_action') or
        (as_timestamp(now()) - as_timestamp(states('var.central_heating_last_action'))) > 10
      }}

    then:
      - service: var.set
        target:
          entity_id: var.central_heating_last_action
        data:
          value: "{{ now().isoformat() }}"

      - repeat:
          count: 3
          sequence:
            - service: switch.toggle
              target:
                entity_id: switch.boiler_fingerbot
            - delay:
                seconds: 2

    else:
      - service: script.log_exception
        data:
          calling_entity: switch.central_heating
          message: >-
            Central heating toggle blocked - next available at
            {{
              (as_timestamp(states('var.central_heating_last_action')) + 10)
              | timestamp_custom('%H:%M:%S')
            }}

turn_off:
  - if: >
      {{
        not has_value('var.central_heating_last_action') or
        not states('var.central_heating_last_action') or
        (as_timestamp(now()) - as_timestamp(states('var.central_heating_last_action'))) > 10
      }}

    then:
      - service: var.set
        target:
          entity_id: var.central_heating_last_action
        data:
          value: "{{ now().isoformat() }}"

      - service: switch.toggle
        target:
          entity_id: switch.boiler_fingerbot

    else:
      - service: script.log_exception
        data:
          calling_entity: switch.central_heating
          message: >-
            Central heating toggle blocked - next available at
            {{
              (as_timestamp(states('var.central_heating_last_action')) + 10)
              | timestamp_custom('%H:%M:%S')
            }}
