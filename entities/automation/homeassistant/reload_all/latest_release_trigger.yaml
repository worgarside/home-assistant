---
alias: /homeassistant/reload_all/latest_release_trigger

id: homeassistant_reload_all_latest_release_trigger

mode: single

trigger:
  - platform: state
    entity_id: sensor.system_reloadable_files_changed
    for:
      minutes: 1

condition:
  and:
    - condition: state
      entity_id: input_boolean.system_latest_release_downloaded
      state: "on"
    - not:
        - condition: state
          entity_id: sensor.system_reloadable_files_changed
          state: "0"

action:
  - service: script.debug_persistent_notification
    data:
      notification_id: homeassistant_reload_all_latest_release_trigger
      title: "Home Assistant Update: Reloading All Integrations"
      message: |
        Version {{ states('sensor.current_git_ref') }} has been downloaded.
        Calling `homeassistant.reload_all` service.

  # Clear any pending reload notifications
  - service: notify.mobile_app_will_s_pixel_6_pro
    data:
      message: clear_notification
      data:
        tag: system_reload_required

  - service: persistent_notification.dismiss
    data:
      notification_id: system_reload_required

  - alias: Clear latest release downloaded flag if a restart is not also required
    if:
      - condition: state
        entity_id: sensor.system_restart_required_files_changed
        state: "0"
    then:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.system_latest_release_downloaded

  - service: homeassistant.check_config

  - service: homeassistant.reload_all
