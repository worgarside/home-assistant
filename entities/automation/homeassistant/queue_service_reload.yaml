---
alias: /homeassistant/queue-service-reload

id: homeassistant_queue_service_reload

mode: queued

trigger:
  platform: event
  event_type: folder_watcher
  event_data:
    event_type: modified

condition: "{{ trigger.event.data.path.startswith('/config/entities') }}"

variables:
  domain: "{{ trigger.event.data.path.split('/')[3] }}"

  service_mapping:
    media_player: universal
    template_triggered: template

  service: "{{ service_mapping.get(domain, domain) }}"

action:
  - choose:
      - conditions: >-
          {{
            service in (
              "automation",
              "command_line",
              "conversation",
              "group",
              "input_boolean",
              "input_button",
              "input_datetime",
              "input_number",
              "input_select",
              "input_text",
              "mqtt",
              "rest",
              "rest_command",
              "scene",
              "schedule",
              "script",
              "template",
              "timer",
              "universal",
              "var",
              "zone"
            )
          }}
        sequence:
          - service: script.turn_on
            target:
              entity_id: script.debug_persistent_notification
            data:
              variables:
                notification_title: Auto-Reloading `{{ service }}` Entities
                message: >-
                  Reloading {{ service }} entities. Triggered by
                  `{{ trigger.event.data.folder }}/{{ trigger.event.data.file}}`
                notification_id: "{{ service }}_auto_reload"

          - variables:
              orig_files: "{{ state_attr('var.auto_reload_queue', 'files') or [] }}"

              new_files: >-
                {{
                  iif(
                    trigger.event.data.file in orig_files,
                    orig_files,
                    orig_files + [trigger.event.data.file]
                  )
                }}

              orig_service_queue: "{{ state_attr('var.auto_reload_queue', 'service_queue') or [] }}"

              new_service_queue: >-
                {{
                  iif(
                    service in orig_service_queue,
                    orig_service_queue,
                    orig_service_queue + [service]
                  )
                }}

          - service: var.set
            target:
              entity_id: var.auto_reload_queue
            data:
              value: "{{ new_files | length }}"
              attributes: >-
                {{
                  {
                    "files":  new_files | to_json,
                    "service_queue": new_service_queue | to_json
                  }
                }}

    default:
      - service: script.turn_on
        target:
          entity_id: script.log_exception
        data:
          variables:
            message: "Unknown service: {{ service }}"
            calling_entity: automation.homeassistant_queue_service_reload
