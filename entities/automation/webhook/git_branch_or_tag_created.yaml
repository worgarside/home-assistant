---
alias: /webhook/git_branch_or_tag_created

id: webhook_git_branch_or_tag_created

mode: queued

trigger:
  - platform: webhook
    webhook_id: git_branch_or_tag_created
    allowed_methods:
      - POST
    local_only: false

condition:
  - condition: template
    value_template: >-
      {{
        trigger.json["repository"]["name"] == "home-assistant"
      }}

action:
  - choose:
      - conditions: >-
          {{
            trigger.json["ref_type"] == "tag" and
            trigger.json["ref"] is match("^\d+\.\d+\.\d+$")
          }}

        sequence:
          - service: persistent_notification.create
            data:
              title: "Updating Config ({{trigger.json['ref']}})"
              message: |
                ## Webhook Payload
                ```json
                {{ trigger.json }}
                ```

          - service: shell_command.checkout_git_branch
            data:
              api_token: !secret api_bearer_token
              branch: main
              entity_ids: sensor.current_git_branch,sensor.current_git_ref

      - conditions: "{{ trigger.json['ref_type'] == 'branch' }}"

        sequence:
          - service: homeassistant.update_entity
            target:
              entity_id: sensor.remote_git_branches
