---
alias: /webhook/get_latest_release
id: webhook_get_latest_release
mode: queued
trigger:
  - platform: webhook
    webhook_id: get_latest_release
    allowed_methods:
      - POST
    local_only: false
action:
  - alias: Validate Payload
    condition: template
    value_template: |
      {{
        trigger.json["ref_type"] == "tag" and
        trigger.json["repository"]["name"] == "home-assistant" and
        trigger.json["ref"] is match("^\d+\.\d+\.\d+$")
      }}
  - service: persistent_notification.create
    data:
      title: "Updating Config ({{trigger.json['ref']}})"
      message: |
        ```json
        {{ trigger.json | to_json }}
        ```
  - service: shell_command.get_latest_release
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.current_git_branch
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.current_git_ref
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.current_appdaemon_ref
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.current_appdaemon_branch
