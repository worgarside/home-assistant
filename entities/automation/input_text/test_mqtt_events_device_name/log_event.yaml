---
alias: /input-text/test-mqtt-events-device-name/log-event

id: input_text_test_mqtt_events_device_name_log_event

description: >-
  Log MQTT device events for the device name specified in input_text.test_mqtt_events_device_name.
  This automation listens to Zigbee2MQTT MQTT topics and filters by device name to capture device
  events.

mode: queued

max: 100

trigger:
  - platform: mqtt
    topic: zigbee2mqtt/+/action
  - platform: mqtt
    topic: zigbee2mqtt/+/click
  - platform: mqtt
    topic: zigbee2mqtt/+/#

variables:
  target_device_name: "{{ states('input_text.test_mqtt_events_device_name') }}"
  topic_parts: "{{ trigger.topic.split('/') }}"
  device_name_from_topic: "{{ topic_parts[1] if topic_parts | length > 1 else '' }}"

condition:
  - condition: template
    value_template: >-
      {{
        target_device_name != '' and
        device_name_from_topic | lower == target_device_name | lower
      }}

action:
  - service: script.turn_on
    target:
      entity_id: script.debug_persistent_notification
    data:
      variables:
        notification_title: MQTT Device Event ({{ device_name_from_topic }})
        message: |
          **Target Device Name:** {{ target_device_name }}

          **Device Name from Topic:** {{ device_name_from_topic }}

          **MQTT Topic:** {{ trigger.topic }}

          **MQTT Payload:**
          ```json
          {{ trigger.payload | default('No payload') }}
          ```

          **Parsed JSON Payload (if JSON):**
          ```json
          {{ trigger.payload_json | default('Not JSON or no payload') | tojson(indent=2) }}
          ```

          **Full Trigger Object:**
          ```json
          {{ trigger | tojson(indent=2) }}
          ```
        notification_id: mqtt_device_event_{{ device_name_from_topic }}
