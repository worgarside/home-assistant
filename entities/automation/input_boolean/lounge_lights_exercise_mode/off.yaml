---
alias: /input-boolean/lounge-lights-exercise-mode/off

id: input_boolean_lounge_lights_exercise_mode_off

description: >-
  Disable exercise mode - re-enable occupancy automation if it was enabled before

mode: single

trigger:
  - platform: state
    entity_id: input_boolean.lounge_lights_exercise_mode
    from: "on"
    to: "off"

action:
  - repeat:
      for_each:
        - automation.binary_sensor_lounge_occupancy_off
        - automation.binary_sensor_lounge_occupancy_on
        - automation.binary_sensor_lounge_occupancy_room_timeout
      sequence:
          # Re-enable the automation only if it was enabled before
        - if: >-
            {{
              state_attr(
                "var.lounge_occupancy_automation_state_pre_exercise_mode",
                repeat.item
              )
              | bool(false)
            }}
          then:
            - service: automation.turn_on
              target:
                entity_id: "{{ repeat.item }}"

  - alias: Turn off lounge lights if room is empty
    if: "{{ is_state('binary_sensor.lounge_occupancy', 'off') }}"
    then:
      - service: light.turn_off
        target:
          area_id: lounge
