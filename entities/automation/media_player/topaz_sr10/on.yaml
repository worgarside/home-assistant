---
alias: /media-player/topaz-sr10/on

id: media_player_topaz_sr10_on

description: >-
  Automation to run when the Topaz SR10 is turned on by something other than the
  `media_player.turn_on` service.

mode: single

trigger:
  platform: state
  entity_id: media_player.topaz_sr10
  from: "off"
  to:
    - "on"
    - "playing"
    - "paused"
    - "idle"
    - "standby"

action:
  - if: "{{ is_state('switch.office_amp', 'off') }}"

    then:
      - service: switch.turn_on
        target:
          entity_id: switch.office_amp

  - delay:
      seconds: >-
        {{
          iif(
            has_value('switch.office_amp'),
            max(
              5 + (
                states.switch.office_amp.last_changed - utcnow()
              ).total_seconds(),
              0
            ),
            0
          )
        }}

  - alias: Set Amp to Correct Input
    service: media_player.select_source
    target:
      entity_id: media_player.topaz_sr10
    data:
      source: MP3/Aux

    then:
      - alias: Initialize volume
        repeat:
          count: 15
          sequence:
            - service: script.topaz_sr10_volume_up
