---
alias: /input-datetime/next-bedroom-sunrise/sunrise-start

id: input_datetime_next_bedroom_sunrise_sunrise_start

description: Start the bedroom sunrise alarm when the scheduled time is reached

mode: restart

trigger:
  - platform: time
    at: input_datetime.next_bedroom_sunrise

condition: "{{ states('zone.home') | int(0) > 0 }}"

variables:
  original_start_time: "{{ states('input_datetime.next_bedroom_sunrise') }}"
  max_brightness_pct: "{{ states('input_number.bedroom_sunrise_max_brightness') | int(100) }}"
  sunrise_duration: "{{ states('input_number.bedroom_sunrise_duration') | int(30) }}"

action:
  - if: "{{ is_state('light.bedroom_shapes', 'on') }}"
    then:
      - alias: Reset next sunrise to tomorrow
        service: script.reset_next_bedroom_sunrise

      - stop: "Bedroom shapes are already on, skipping sunrise start"

  - alias: Turn on bedroom shapes with deep orange
    service: light.turn_on
    target:
      entity_id: light.bedroom_shapes
    data:
      brightness_pct: 1
      rgb_color: [255, 140, 0] # Deep orange
      transition: 0

  - alias: Send sunrise notification
    service: script.send_bedroom_sunrise_notification

  - alias: Gradual brightness increase over sunrise duration
    repeat:
      while: >-
        {{
          is_state('input_datetime.next_bedroom_sunrise', original_start_time) and
          repeat.index < sunrise_duration
        }}
      sequence:
        - alias: Increase brightness
          service: light.turn_on
          target:
            entity_id: light.bedroom_shapes
          data:
            brightness_pct: "{{ (repeat.index * max_brightness_pct / sunrise_duration) | round(0) }}"
            rgb_color: [255, 140, 0] # Deep orange
            transition: 60 # 1 minute transition

        - alias: Wait 1 minute
          delay:
            minutes: 1

  - if: "{{ is_state('input_datetime.next_bedroom_sunrise', original_start_time) }}"
    then:
      - alias: Final brightness at max level
        service: light.turn_on
        target:
          entity_id: light.bedroom_shapes
        data:
          brightness_pct: "{{ max_brightness_pct }}"
          rgb_color: [255, 140, 0] # Deep orange
          transition: 60

      - alias: Reset next sunrise to tomorrow
        service: script.reset_next_bedroom_sunrise

  - alias: Clear sunrise notifications
    service: script.send_bedroom_sunrise_notification
    data:
      clear_notification: true
