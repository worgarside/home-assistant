---
alias: /input-datetime/habit/will-habit-binary-8/reminder

id: input_datetime_habit_will_habit_binary_8_reminder

description: Remind to log Will's binary habit 8 at configured reminder time

mode: single

trigger:
  - platform: time
    at: input_datetime.will_habit_binary_8_reminder_time

condition: >-
  {{
    is_state('input_boolean.will_habit_binary_8', 'off') and
    states("input_text.will_habit_binary_8_name") not in ["", "unknown"]
  }}

variables:
  habit_name: >-
    {{
      states('input_text.will_habit_binary_8_name')
      | default('Habit Binary 8')
    }}
  repeat_interval: >-
    {{
      states('input_number.will_habit_binary_8_repeat_reminder_interval') | int(60)
    }}
  repeat_reminder_count: >-
    {{
      states('input_number.will_habit_binary_8_repeat_reminder_count') | int(0)
    }}

action:
  - service: script.notify_will
    data:
      title: "Habit Reminder"
      message: "Don't forget to mark {{ habit_name }} as complete!"
      notification_id: will_habit_binary_8_reminder
      url: /home-will/mood-habits

  - if: "{{ repeat_reminder_count | int(0) > 0 }}"
    then:
      - repeat:
          until: >-
            {%
              set cutoff_time = (
                now().replace(hour=0, minute=0, second=0, microsecond=0)
                + timedelta(days=1)
                - timedelta(minutes=(repeat_interval + 5))
              )
            %}
            {% set habit_completed = is_state('input_boolean.will_habit_binary_8', 'on') %}
            {{
              now() >= cutoff_time or
              repeat.index > repeat_reminder_count | int(0) or
              habit_completed
            }}
          sequence:
            - delay:
                minutes: "{{ repeat_interval | int(60) }}"

            - service: script.notify_will
              data:
                title: "Habit Reminder"
                message: "Don't forget to mark {{ habit_name }} as complete!"
                notification_id: will_habit_binary_8_reminder
                url: /home-will/mood-habits
