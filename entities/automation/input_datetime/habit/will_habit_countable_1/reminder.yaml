---
alias: /input-datetime/habit/will-habit-countable-1/reminder

id: input_datetime_habit_will_habit_countable_1_reminder

description: Remind to log Will's countable habit 1 at configured reminder time

mode: single

trigger:
  - platform: time
    at: input_datetime.will_habit_countable_1_reminder_time

condition: >-
  {{
    states('input_number.will_habit_countable_1') | int(0) == 0 and
    states("input_text.will_habit_countable_1_name") not in ["", "unknown"]
  }}

variables:
  habit_name: >-
    {{ states('input_text.will_habit_countable_1_name')
    | default('Habit Countable 1') }}
  repeat_interval: >-
    "{{ states('input_number.will_habit_countable_1_repeat_reminder_interval') | int(60) }}"
  repeat_reminder_count: >-
    "{{ states('input_number.will_habit_countable_1_repeat_reminder_count') | int(0) }}"

action:
  - service: script.notify_will
    data:
      title: "Habit Reminder"
      message: "Don't forget to track {{ habit_name }}!"
      notification_id: will_habit_countable_1_reminder
      url: /home-will/mood-habits

  - if: "{{ repeat_reminder_count | int(0) > 0 }}"
    then:
      - repeat:
          until: >-
            {%
              set cutoff_time = (
                now().replace(hour=0, minute=0, second=0, microsecond=0)
                + timedelta(days=1)
                - timedelta(minutes=(repeat_interval + 5))
              )
            %}
            {% set habit_completed = states('input_number.will_habit_countable_1') | int(0) > 0 %}
            {{
              now() >= cutoff_time or
              repeat.index > repeat_reminder_count | int(0) or
              habit_completed
            }}
          sequence:
            - delay:
                minutes: "{{ repeat_interval | int(60) }}"

            - service: script.notify_will
              data:
                title: "Habit Reminder"
                message: "Don't forget to track {{ habit_name }}!"
                notification_id: will_habit_countable_1_reminder
                url: /home-will/mood-habits
