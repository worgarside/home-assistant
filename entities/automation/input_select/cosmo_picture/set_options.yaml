---
alias: /input_select/cosmo_picture/set_options

id: input_select_cosmo_picture_set_options

mode: restart

trigger:
  - platform: event
    event_type: folder_watcher

  - platform: homeassistant
    event: start

variables:
  image_directory: /config/www/images/cosmo

condition: >-
  {{
    trigger.platform == "homeassistant" or
    trigger.event.data.folder.startswith(image_directory)
  }}

action:
  - alias: Get files
    service: shell_command.ls
    response_variable: files
    data:
      path: "{{ image_directory }}"

  - service: script.debug_persistent_notification
    data:
      title: "`script.input_select_cosmo_picture_set_options`"
      message: "{{ files | tojson(indent=2) }}"

  - variables:
      default_options: >-
        {% if files.returncode == 0 %}
          {{ [] }}
        {% else %}
          {{ ( files | default({"_": "ERROR: `files` not defined"}) ).values() | list }}
        {% endif %}

  - service: input_select.set_options
    target:
      entity_id: input_select.cosmo_entity_picture
    data_template:
      options: "{{ ( files | default(default_options) ).stdout | default(default_options) }}"
