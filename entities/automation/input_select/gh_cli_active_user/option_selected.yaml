---
alias: /input-select/gh-cli-active-user/option-selected

id: input_select_gh_cli_active_user_option_selected

mode: queued

trigger:
  platform: state
  entity_id: input_select.gh_cli_active_user
  not_to:
    - unavailable
    - unknown

condition:
  and:
    - alias: Validate new user selected
      condition: template
      value_template: "{{ trigger.to_state.state != states('sensor.current_gh_cli_user') }}"

action:
  - service: shell_command.gh
    response_variable: gh_res
    data:
      command: auth switch
      args: --user {{ trigger.to_state.state }}

  - if: "{{ gh_res.returncode | int(-1) != 0 }}"

    then:
      - service: script.turn_on
        target:
          entity_id: script.log_exception
        data:
          variables:
            notification_title: GH CLI Error
            message: |
              ```json
              {{ gh_res | tojson(indent=2) }}
              ```

    else:
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.current_gh_cli_user
