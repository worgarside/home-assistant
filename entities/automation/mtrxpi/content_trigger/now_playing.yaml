---
alias: /mtrxpi/content-trigger/now-playing

id: mtrxpi_content_trigger_now_playing

mode: restart

trigger:
  - platform: state
    entity_id: media_player.topaz_sr10

action:
  - parallel:
      - if: "{{ states('sensor.mtrxpi_current_content') != 'now-playing' }}"
        then:
          - service: script.mtrxpi_queue_content
            data:
              id: now-playing
              priority: 10

      - service: mqtt.publish
        data:
          topic: /mtrxpi/now-playing/parameter/title
          payload_template: "{{ trigger.to_state.attributes.media_title | to_json }}"
          qos: 1
          retain: true

      - service: mqtt.publish
        data:
          topic: /mtrxpi/now-playing/parameter/artist
          payload_template: "{{ trigger.to_state.attributes.media_artist | to_json }}"
          qos: 1
          retain: true

      - service: mqtt.publish
        data:
          topic: /mtrxpi/now-playing/parameter/album
          payload_template: "{{ trigger.to_state.attributes.media_album_name | to_json }}"
          qos: 1
          retain: true

      - service: mqtt.publish
        data:
          topic: /mtrxpi/now-playing/parameter/artwork-uri
          payload_template: >-
            {%- set url = trigger.to_state.attributes.entity_picture -%}
            {%-
              set host = (
                states('sensor.local_ip')
                if has_value('sensor.local_ip')
                else "homeassistant.local"
              )
            -%}
            {{-
              (
                "http://" ~ host ~ ":8123" ~ url
                if url is string and url.startswith("/api/")
                else url
              ) | to_json
            -}}
          qos: 1
          retain: true
