---
alias: /mtrxpi/content-trigger/now-playing

id: mtrxpi_content_trigger_now_playing

mode: restart

trigger:
  - platform: state
    entity_id: media_player.topaz_sr10

variables:
  from_attrs: "{{ trigger.from_state.attributes | to_json }}"
  to_attrs: "{{ trigger.to_state.attributes | to_json }}"

action:
  - parallel:
      - if: "{{ states('sensor.mtrxpi_current_content') != 'now-playing' }}"
        then:
          - service: script.mtrxpi_queue_content
            data:
              id: now-playing
              priority: 10

      - if: "{{ from_attrs.media_title != to_attrs.media_title }}"
        then:
          - service: mqtt.publish
            data_template:
              topic: /mtrxpi/now-playing/parameter/title
              payload: "{{ to_attrs.media_title }}"

      - if: "{{ from_attrs.media_artist != to_attrs.media_artist }}"
        then:
          - service: mqtt.publish
            data_template:
              topic: /mtrxpi/now-playing/parameter/artist
              payload: "{{ to_attrs.media_artist }}"

      - if: "{{ from_attrs.media_album_name != to_attrs.media_album_name }}"
        then:
          - service: mqtt.publish
            data_template:
              topic: /mtrxpi/now-playing/parameter/album
              payload: "{{ to_attrs.media_album_name }}"

      - if: "{{ from_attrs.entity_picture != to_attrs.entity_picture }}"
        then:
          - service: mqtt.publish
            data_template:
              topic: /mtrxpi/now-playing/parameter/artwork-uri
              payload: >-
                {%- set url = state_attr('media_player.topaz_sr10', 'entity_picture') -%}
                {%-
                  set host = (
                    states('sensor.local_ip')
                    if has_value('sensor.local_ip')
                    else "homeassistant.local"
                  )
                -%}
                {{-
                  "http://" ~ host ~ ":8123" ~ url
                  if url is string and url.startswith("/api/")
                  else url
                -}}
