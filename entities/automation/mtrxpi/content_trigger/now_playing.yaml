---
alias: /mtrxpi/content-trigger/now-playing

id: mtrxpi_content_trigger_now_playing

mode: restart

trigger:
  - platform: state
    entity_id: media_player.topaz_sr10

action:
  - parallel:
      - if: "{{ states('sensor.mtrxpi_current_content') != 'now-playing' }}"
        then:
          - service: script.mtrxpi_queue_content
            data:
              id: now-playing
              priority: 10

      - service: mqtt.publish
        data:
          topic: /mtrxpi/now-playing/parameter/track-metadata
          qos: 1
          retain: true
          payload_template: >-
            {%- set url = trigger.to_state.attributes.entity_picture -%}
            {%-
              set host = (
                states('sensor.local_ip')
                if has_value('sensor.local_ip')
                else "homeassistant.local"
              )
            -%}
            {{
              {
                "title": trigger.to_state.attributes.media_title,
                "album": trigger.to_state.attributes.media_album_name,
                "artist": trigger.to_state.attributes.media_artist,
                "artwork_uri": (
                  "http://" ~ host ~ ":8123" ~ url
                  if url is string and url.startswith("/api/")
                  else url
                )
              } | to_json
            }}
