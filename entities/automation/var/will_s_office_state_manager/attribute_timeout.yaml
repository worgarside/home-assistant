---
alias: /var/will-s-office-state-manager/attribute-timeout

id: var_will_s_office_state_manager_attribute_timeout

description: Timeout for "should be" on/off attributes of Will's desk state manager

mode: single

trigger:
  - platform: template
    value_template: >-
      {%
        set cached_states =
          state_attr("var.will_s_office_state_manager", "entity_states_b64")
          | base64_decode
          | from_json
      %}
      {%- set ns = namespace(keys=[]) %}
      {%
        for k in cached_states.keys()
        if cached_states.get(k) | bool(false) and is_state(k, "off") and area_id(k) == "office"
      %}
        {% set ns.keys = ns.keys + [k] %}
      {% endfor %}
      {{ ns.keys | count > 0 }}
    for:
      hours: 1

action:
  - variables:
      cached_states: >-
        {{
          state_attr("var.will_s_office_state_manager","entity_states_b64")
          | base64_decode
          | from_json
        }}

  - variables:
      entity_states: >-
        {%- set ns = namespace(output=cached_states) %}
        {%
          for k in cached_states.keys()
          if cached_states.get(k) | bool(false) and is_state(k, "off") and area_id(k) == "office"
        %}
          {% set ns.output = dict(ns.output, **{k: false}) %}
        {% endfor %}
        {{ ns.output }}

  - service: var.set
    target:
      entity_id: var.will_s_office_state_manager
    data:
      attributes:
        entity_states_b64: "{{ entity_states | to_json | base64_encode }}"
