---
alias: /var/vic-s-office-state-manager/attribute-timeout

id: var_vic_s_office_state_manager_attribute_timeout

description: Timeout for "should be" on/off attributes of Vic's desk state manager

mode: single

trigger:
  - platform: template
    value_template: >-
      {%
        set cached_states =
          state_attr("var.vic_s_office_state_manager", "entity_states_b64")
          | base64_decode
          | from_json
      %}
      {%- set ns = namespace(keys=[]) %}
      {%
        for k in cached_states.keys()
        if cached_states.get(k) | bool(false) and is_state(k, "off") and area_id(k) == "vic_s_office"
      %}
        {% set ns.keys = ns.keys + [k] %}
      {% endfor %}
      {{ ns.keys | count > 0 }}
    for:
      hours: 1

action:
  - service: script.state_manager_attribute_timeout
    data:
      state_manager: var.vic_s_office_state_manager
