---
alias: /folder-watcher/reloadable-file-changed
id: folder_watcher_reloadable_file_changed
mode: queued
max: 50
trigger:
  - platform: event
    event_type: folder_watcher
    event_data:
      event_type: created
  - platform: event
    event_type: folder_watcher
    event_data:
      event_type: deleted
  - platform: event
    event_type: folder_watcher
    event_data:
      event_type: modified
  - platform: event
    event_type: folder_watcher
    event_data:
      event_type: moved
condition: >
  {% set ns = namespace() %}
  {% set path = trigger.event.data.path %}
  {%
    if (
      path not in (
        state_attr('var.reloadable_files_changed', 'updated_files') or []
      )
    )
  %}
    {%
      set patterns = [
        '^/config/entities/(automation|binary_sensor|script|shell_command|template|var)/',
        '^/config/entities/command_line/(binary_)?sensor/',
        '^/config/entities/input_[a-z_]*/',
        '^/config/integrations/input_[a-z_]+\.yaml',
        '^/config/integrations/(rest|shell)_command\.yaml',
        '^/config/integrations/(automation|binary_sensor|command_line|cover|device_tracker)\.yaml',
        '^/config/integrations/(folder_watcher|group|lovelace|media_player|mqtt|scene|script)\.yaml',
        '^/config/integrations/(sensor|template|timer|tts|var|webhook|zone)\.yaml',
        '^/lovelace/',
      ]
    %}

    {% for pattern in patterns if path | regex_match(pattern) %}
      {% set ns.match_found = true %}
      {% break %}
    {% endfor %}
  {% endif %}

  {{ ns.match_found | default(false) }}
action:
  - service: var.set
    data:
      entity_id: var.reloadable_files_changed
    data_template:
      value: "{{ ( states('var.reloadable_files_changed') | int ) + 1 }}"
      icon: >-
        {% if ( states('var.reloadable_files_changed') | int ) > 0 %}
          mdi:reload-alert
        {% else %}
          mdi:reload
        {% endif %}
      attributes:
        updated_files: >-
          {{
            (
              state_attr('var.reloadable_files_changed', 'updated_files') or []
            ) + [trigger.event.data.path]
          }}
