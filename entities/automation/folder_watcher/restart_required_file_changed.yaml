---
alias: /folder-watcher/restart-required-file-changed
id: folder_watcher_restart_required_file_changed
mode: queued
max: 50
trigger:
  - platform: event
    event_type: folder_watcher
    event_data:
      event_type: created
  - platform: event
    event_type: folder_watcher
    event_data:
      event_type: deleted
  - platform: event
    event_type: folder_watcher
    event_data:
      event_type: modified
  - platform: event
    event_type: folder_watcher
    event_data:
      event_type: moved
condition: >
  {% set ns = namespace() %}
  {% set path = trigger.event.data.path %}
  {%
    if (
      path not in (
        state_attr('var.restart_required_files_changed', 'updated_files') or []
      )
    )
  %}
    {%
      set patterns = [
        '^/config/entities/(cover|device_tracker|media_player|sensor)/',
        '^/config/entities/mqtt/(binary_)?sensor/',
        '^/config/integrations/log(book|ger)\.yaml',
        '^/config/integrations/media_(extractor|source)\.yaml',
        '^/config/integrations/system_(health|log)\.yaml',
        '^/config/integrations/(websocket_)?api\.yaml',
        '^/config/integrations/(api|cloud|config|frontend|hardware|history|map|mobile_app|my)\.yaml',
        '^/config/integrations/(network|person|recorder|spotcast|ssdp|sun|tag|usb|zeroconf|zha)\.yaml',
        '^/config/secrets\.yaml',
      ]
    %}

    {% for pattern in patterns if path | regex_match(pattern) %}
      {% set ns.match_found = true %}
      {% break %}
    {% endfor %}
  {% endif %}

  {{ ns.match_found | default(false) }}
action:
  - service: var.set
    data:
      entity_id: var.restart_required_files_changed
    data_template:
      value: "{{ ( states('var.restart_required_files_changed') | int ) + 1 }}"
      icon: >-
        {% if ( states('var.restart_required_files_changed') | int ) > 0 %}
          mdi:restart-alert
        {% else %}
          mdi:restart
        {% endif %}
      attributes:
        updated_files: >-
          {{
            (
              state_attr('var.restart_required_files_changed', 'updated_files') or []
            ) + [trigger.event.data.path]
          }}
