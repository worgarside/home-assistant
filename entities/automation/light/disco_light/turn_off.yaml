---
alias: /light/disco-light/turn-off

id: light_disco_light_turn_off

mode: single

trigger:
  - platform: state
    id: lounge_speakers_paused
    entity_id: media_player.lounge_speakers
    to: paused
    for:
      minutes: 2

  - platform: state
    id: lounge_speakers_other
    entity_id: media_player.lounge_speakers
    from: playing
    not_to:
      - paused
      - buffering
    for:
      minutes: 2

  - platform: state
    id: hifi_system
    entity_id: media_player.hifi_system
    from: playing
    for:
      minutes: 1

condition: >-
  {%
    set hifi_system_music_source = (
      state_attr("media_player.hifi_system","source") in ("HEOS Music", "Phono")
    )
  %}
  {% set lounge_speakers_state = states("media_player.lounge_speakers") %}
  {{
    (
      trigger.id == "hifi_system" and
      hifi_system_music_source and
      states("media_player.lounge_speakers") not in ("on", "playing")
    ) or (
      trigger.id.startswith("lounge_speakers") and not (
        hifi_system_music_source and
        states("media_player.hifi_system") in ("on", "playing")
      )
    )
  }}

action:
  - service: light.turn_off
    target:
      entity_id: light.disco_light
