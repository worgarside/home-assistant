---
alias: /light/glowstick/rain-flash

id: light_glowstick_rain_flash

mode: single

max_exceeded: silent

trigger:
  - platform: numeric_state
    entity_id: sensor.tomorrow_io_rain_intensity
    above: 0

variables:
  # Store the original state of the glowstick
  original_state: "{{ is_state('light.glowstick', 'on') }}"
  original_brightness: "{{ state_attr('light.glowstick', 'brightness') | int(128) }}"
  original_rgb_color: "{{ state_attr('light.glowstick', 'rgb_color') | default([255, 255, 255]) }}"

  # Check if we're within the 2-hour cooldown period
  last_flash_time: >
    {{
      state_attr("var.rain_flash_cooldown", "last_flash_time") |
      as_timestamp("1970-01-01T00:00:00+00:00")
    }}
  cooldown_expired: "{{ (as_timestamp(now()) - as_timestamp(last_flash_time)) > 7200 }}"

action:
  - if: "{{ cooldown_expired }}"

    then:
      - alias: Store current time as last flash time
        service: var.set
        target:
          entity_id: var.rain_flash_cooldown
        data:
          attributes:
            last_flash_time: "{{ now().isoformat() }}"

      # First flash
      - service: light.turn_on
        target:
          entity_id: light.glowstick
        data:
          rgb_color: [0, 0, 255]  # Blue
          brightness: 255
          transition: 0.5

      - delay:
          seconds: 1

      # Second flash
      - service: light.turn_on
        target:
          entity_id: light.glowstick
        data:
          rgb_color: [0, 0, 255]  # Blue
          brightness: 255
          transition: 0.5

      - delay:
          seconds: 1

      - alias: Restore original state
        if:
          - condition: template
            value_template: "{{ original_state }}"
        then:
          - service: light.turn_on
            target:
              entity_id: light.glowstick
            data:
              rgb_color: "{{ original_rgb_color }}"
              brightness: "{{ original_brightness }}"
              transition: 1
        else:
          - service: light.turn_off
            target:
              entity_id: light.glowstick
            data:
              transition: 1
