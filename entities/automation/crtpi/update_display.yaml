---
alias: /crtpi/update-display

id: crtpi_update_display

mode: queued

trigger:
  - platform: state
    entity_id: media_player.lounge_speakers

variables:
  media_player: media_player.lounge_speakers

  album_artwork_url_prefix: |
    {% set url = state_attr(media_player, 'entity_picture') %}
    {{
      "http://homeassistant.local:8123"
      if url and url.startswith('/api/')
      else ""
    }}

  payload: >-
    {{
      {
        "title": state_attr(media_player, 'media_title'),
        "artist": state_attr(media_player, 'media_artist'),
        "album": state_attr(media_player, 'media_album_name'),
        "album_artwork_url": album_artwork_url_prefix ~ state_attr(media_player, 'entity_picture'),
        "state": states(media_player)
      }
    }}

action:
  - service: script.turn_on
    target:
      entity_id: script.debug_persistent_notification
    data:
      variables:
        notification_title: CRT Display Update
        message: |
          ```json
          {{ payload | tojson(indent=2) }}
          ```

          ```
          Topic:   /crtpi/crt-interface/content
          Time:    {{ now().strftime('%Y-%m-%d %H:%M:%S.%f') }}
          ```

  - service: mqtt.publish
    data:
      topic: /crtpi/crt-interface/content
      payload: "{{ payload | tojson }}"
