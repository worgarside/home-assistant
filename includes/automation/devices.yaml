---

# MacBook Pro

  - alias: /switch/will_s_macbook_pro/turn_on/docked
    id: will_s_macbook_pro_docked
    trigger:
      - platform: state
        entity_id: binary_sensor.will_s_macbook_pro_docked
        to: "on"
    condition: "{{ states('sensor.wills_macbook_pro_internal_battery_level') | int < 25 }}"
    action:
      - service: switch.turn_on
        data:
          entity_id: switch.macbook_pro

  - alias: /switch/will_s_macbook_pro/turn_on/battery_low
    id: will_s_macbook_pro_battery_low
    trigger:
      - platform: numeric_state
        entity_id: sensor.wills_macbook_pro_internal_battery_level
        below: 25
    condition: "{{ states('binary_sensor.will_s_macbook_pro_docked') == 'on' }}"
    action:
      - service: switch.turn_on
        data:
          entity_id: switch.macbook_pro

  - alias: /switch/will_s_macbook_pro/turn_off/undocked
    id: will_s_macbook_pro_undocked
    trigger:
      - platform: state
        entity_id: binary_sensor.will_s_macbook_pro_docked
        to: "off"
    action:
      - service: switch.turn_off
        data:
          entity_id: switch.macbook_pro

  - alias: /switch/will_s_macbook_pro/turn_off/battery_full
    id: will_s_macbook_pro_battery_full
    trigger:
      - platform: numeric_state
        entity_id: sensor.wills_macbook_pro_internal_battery_level
        above: 95
    action:
      - service: switch.turn_off
        data:
          entity_id: switch.macbook_pro

# HiFi Amp

  - alias: /switch/hifi_amp/auto_on
    id: auto_on_hifi_amp
    trigger:
      - platform: state
        entity_id:
          - media_player.hifi_system
          - media_player.lounge_bravia_tv
        from:
          - idle
          - "off"
          - unavailable
          - unknown
        to:
          - idle
          - paused
          - playing
    action:
      - service: switch.turn_on
        entity_id: switch.hifi_amp

  - alias: /switch/hifi_amp/auto_off
    id: auto_off_hifi_amp
    trigger:
      - platform: state
        entity_id:
          - media_player.hifi_system
          - media_player.lounge_bravia_tv
        to:
          - "off"
        for:
          minutes: 1
    condition:
      - condition: and
        conditions:
          - condition: state
            entity_id: media_player.hifi_system
            state: "off"
          - condition: state
            entity_id: media_player.lounge_bravia_tv
            state: "off"
    action:
      # yamllint disable-line rule:line-length
      - wait_template: "{{ states('media_player.hifi_system') == 'off' and states('media_player.lounge_bravia_tv') == 'off'  and states('media_player.lounge_tv') != 'unavailable' }}"
        timeout: 300
        continue_on_timeout: false
      - service: switch.turn_off
        entity_id: switch.hifi_amp

# Lounge TV

  - alias: /media_player/lounge_bravia_tv/limit_volume
    id: limit_media_player_lounge_bravia_tv_volume
    trigger:
      - platform: numeric_state
        entity_id: media_player.lounge_bravia_tv
        attribute: volume_level
        above: 0.6
        for:
          seconds: 2
    action:
      - service: media_player.volume_set
        data:
          volume_level: 0.6
        target:
          entity_id: media_player.lounge_bravia_tv

# Office Desk

  - alias: /cover/office_desk/work_mode
    id: office_desk_work_mode
    trigger:
      - platform: time_pattern
        minutes: 58
    condition:
      - alias: "If standing target has not been met"
        condition: numeric_state
        entity_id: sensor.office_desk_standing_mode_percentage
        below: input_number.office_desk_standing_mode_percentage_target
    action:
      - alias: "Wait for desk to be occupied"
        wait_template: "{{ states('binary_sensor.office_desk_occupied') == 'on' }}"
        timeout: 3480 # Gives a 2 minute buffer before the next trigger
        continue_on_timeout: false
      - alias: "Delay 30 seconds in case I'm still plugging stuff in"
        delay: 00:00:30
      - alias: "Set desk to standing mode"
        service: script.office_desk_standing_mode
