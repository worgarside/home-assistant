---
debug_persistent_notification:
  description: Create a persistent notification if debugging is turned on
  mode: parallel
  fields:
    title:
      description: The notification's title
      example: Something has happened!
    message:
      description: The notification's message body
      example: More detail about this thing
  sequence:
    - alias: Check if debugging is turned on
      condition: state
      entity_id: input_boolean.debug_with_persistent_notification
      state: "on"
    - service: persistent_notification.create
      data:
        title: '{{ title }}'
        message: '{{ message }}'

notify_will:
  description: Send a notification to Will's phone and the HA UI
  mode: parallel
  fields:
    title:
      description: The title of the notification
      example: Something Important!
    message:
      description: The message body of the notification
      example: A thing has happened, though you ought to know
  sequence:
    - service: persistent_notification.create
      data:
        title: '{{ title }}'
        message: '{{ message }}'
    - service: notify.mobile_app_will_s_pixel_6_pro
      data:
        title: '{{ title }}'
        message: '{{ message }}'

start_spotify_on_device:
  description: Start Spotify playback on a particular device
  mode: restart
  fields:
    entity_id:
      # yamllint disable-line rule:line-length
      description: The ID of the device to start playback on, used in creating a stopping condition for the exponential backoff
      example: entity_id
    device_key:
      # yamllint disable-line rule:line-length
      description: The key to use in identifying the device (i.e. `spotify_device_id` or `entity_id`)
      example: entity_id
    device_value:
      description: The value to use in identifying the device
      example: media_player.hifi_system
    user_name:
      # yamllint disable-line rule:line-length
      description: The name of the user, to determine which Spotify account to use
      example: Dave
  sequence:
    - service: script.debug_persistent_notification
      data:
        title: Spotcast Arguments
        message: |
          device_key: {{ device_key }}
          device_value: {{ device_value }}
          user_name: {{ user_name | lower }}
    - service: spotcast.start
      data:
        '{{device_key}}': '{{ device_value }}'
        account: '{{ user_name | lower }}'
        shuffle: true
        force_playback: true

crt_pi_update_display:
  description: Update the CRT Pi display from the chosen media player's track
  mode: parallel
  sequence:
    - alias: Set Variables
      variables:
        media_player: "{{ states('input_select.crt_pi_display_source') }}"
        album_artwork_url_prefix: |
          {% set url = state_attr(media_player, 'entity_picture') %}
          {{
            "http://homeassistant.local:8123"
            if url and url.startswith('/api/')
            else ""
          }}
    - service: script.debug_persistent_notification
      data:
        title: CRT Display Update
        # yamllint disable rule:line-length
        message: |
          ```
          Title:   {{ state_attr(media_player, 'media_title') }}
          Artist:  {{ state_attr(media_player, 'media_artist') }}
          Album:   {{ state_attr(media_player, 'media_album_name') }}
          Artwork: {{ album_artwork_url_prefix }}{{ state_attr(media_player, 'entity_picture') }}
          State:   {{ states(media_player) }}

          Topic:   /crt-pi/display/update_display
          Time:    {{ now().strftime('%Y-%m-%d %H:%M:%S.%f') }}
          ```
        # yamllint enable rule:line-length
    - service: mqtt.publish
      data:
        topic: /crt-pi/display/update_display
        # yamllint disable rule:line-length
        payload: |
          {
            "title": "{{ state_attr(media_player, 'media_title') }}",
            "artist": "{{ state_attr(media_player, 'media_artist') }}",
            "album": "{{ state_attr(media_player, 'media_album_name') }}",
            "album_artwork_url": "{{ album_artwork_url_prefix }}{{ state_attr(media_player, 'entity_picture') }}",
            "state": "{{ states(media_player) }}"
          }
        # yamllint enable rule:line-length

mtrxpi_update_display:
  description: Update the MtrxPi display from the chosen media player's track
  mode: restart
  sequence:
    - alias: Set Variables
      variables:
        media_player: "{{ states('input_select.mtrxpi_display_source') }}"
        album_artwork_url_prefix: |
          {% set url = state_attr(media_player, 'entity_picture') %}
          {{
            "http://homeassistant.local:8123"
            if url and url.startswith('/api/')
            else ""
          }}
    - service: script.debug_persistent_notification
      data:
        title: RGB LED Matrix Display Update
        # yamllint disable rule:line-length
        message: |
          ```
          Title:   {{ state_attr(media_player, 'media_title') }}
          Artist:  {{ state_attr(media_player, 'media_artist') }}
          Album:   {{ state_attr(media_player, 'media_album_name') }}
          Artwork: {{ album_artwork_url_prefix }}{{ state_attr(media_player, 'entity_picture') }}
          State:   {{ states(media_player) }}

          Topic:   /homeassistant/led_matrix/payload
          Time:    {{ now().strftime('%Y-%m-%d %H:%M:%S.%f') }}
          ```
        # yamllint enable rule:line-length
    - service: mqtt.publish
      data:
        topic: /homeassistant/led_matrix/display
        # yamllint disable rule:line-length
        payload: |
          {
            "title": "{{ state_attr(media_player, 'media_title') }}",
            "artist": "{{ state_attr(media_player, 'media_artist') }}",
            "album": "{{ state_attr(media_player, 'media_album_name') }}",
            "album_artwork_url": "{{ album_artwork_url_prefix }}{{ state_attr(media_player, 'entity_picture') }}",
            "state": "{{ states(media_player) }}"
          }
        # yamllint enable rule:line-length

# YAS-209 Infrared Commands
yas_209_toggle_power:
  mode: single
  sequence:
    - service: zha.issue_zigbee_cluster_command
      data:
        cluster_type: in
        endpoint_id: 1
        command: 2
        ieee: dc:8e:95:ff:fe:f9:ad:13
        command_type: server
        params:
          code: >-
            BUwj7BEoAuADAQHCBuAFA0AB4AMT4AcBQBvAAUALQAPAAUAL4AMDwAHAE8ABD6WdTCPzCCgC//9MI/MIKAI=
        cluster_id: 57348

yas_209_volume_up:
  mode: single
  sequence:
    - service: zha.issue_zigbee_cluster_command
      data:
        cluster_type: in
        endpoint_id: 1
        command: 2
        ieee: dc:8e:95:ff:fe:f9:ad:13
        command_type: server
        params:
          code: >-
            BUojwBEuAuADAQG1BuAFA0AB4AMT4AcBQBtAAUAH4AMD4AMBQBfgBwFAE8ADD6qdSiPqCC4C//9KI+oILgI=
        cluster_id: 57348

yas_209_volume_down:
  mode: single
  sequence:
    - service: zha.issue_zigbee_cluster_command
      data:
        cluster_type: in
        endpoint_id: 1
        command: 2
        ieee: dc:8e:95:ff:fe:f9:ad:13
        command_type: server
        params:
          code: >-
            BUQj0hEpAuADAQHABuAFA0AB4AMTAl0CKeAEAeADG+ADC+APAcA/4AMrD8OdRCPeCCkC//9EI94IKQI=
        cluster_id: 57348

yas_209_set_eq_movie:
  mode: single
  sequence:
    - service: zha.issue_zigbee_cluster_command
      data:
        cluster_type: in
        endpoint_id: 1
        command: 2
        ieee: dc:8e:95:ff:fe:f9:ad:13
        command_type: server
        params:
          code: >-
            BXAjqBExAuADAQGsBuAFA0AB4AMT4AcBwBvAAeADD+APC0ABQBvAAQdunXAj0wgxAg==
        cluster_id: 57348

yas_209_set_eq_tv:
  mode: single
  sequence:
    - service: zha.issue_zigbee_cluster_command
      data:
        cluster_type: in
        endpoint_id: 1
        command: 2
        ieee: dc:8e:95:ff:fe:f9:ad:13
        command_type: server
        params:
          code: >-
            BUsjwBEqAkABAbwG4A0DQAFAG+ALAQNlAioCQBtAA+ADAUAP4AMDQAHgBw/gAwEPlJ1LIwUJKgL//0sjBQkqAg==
        cluster_id: 57348

yas_209_set_eq_music:
  mode: single
  sequence:
    - service: zha.issue_zigbee_cluster_command
      data:
        cluster_type: in
        endpoint_id: 1
        command: 2
        ieee: dc:8e:95:ff:fe:f9:ad:13
        command_type: server
        params:
          code: >-
            BVcj1BEvAuADAQG0BuAFA0AB4AMT4AcBQBtAAeADB+AHC+ADD8ABwBNAAQ+tnVcj1wgvAv//VyPXCC8C
        cluster_id: 57348

yas_209_set_source_tv:
  mode: single
  sequence:
    - service: zha.issue_zigbee_cluster_command
      data:
        cluster_type: in
        endpoint_id: 1
        command: 6
        ieee: dc:8e:95:ff:fe:f9:ad:13
        command_type: server
        params:
          code: >-
            BWgjqhEqAuADAQHABuAFA0AB4AMT4AcB4AMb4AMLQAHADwJcAirgAAHAC0AbwAEPhZ1oI9sIKgL//2gj2wgqAg==
        cluster_id: 57348

yas_209_set_source_hdmi:
  mode: single
  sequence:
    - service: zha.issue_zigbee_cluster_command
      data:
        cluster_type: in
        endpoint_id: 1
        command: 6
        ieee: dc:8e:95:ff:fe:f9:ad:13
        command_type: server
        params:
          code: >-
            BUUjzBEsAuADAQG4BuAFA0AB4AMT4AcBQBtAAeAHB0AB4AcT4AMP4AMLB3ydRSPxCCwC
        cluster_id: 57348

yas_209_volume_mute:
  mode: single
  sequence:
    - service: zha.issue_zigbee_cluster_command
      data:
        cluster_type: in
        endpoint_id: 1
        command: 8
        ieee: dc:8e:95:ff:fe:f9:ad:13
        command_type: server
        params:
          code: >-
            BTcj2REsAuADAQG7BuAFA0AB4AMT4AcBQBvAAUALwAPAAcAPQAfgAwFAD0ADQAEPZJ03I/wILAL//zcj/AgsAg==
        cluster_id: 57348

# Office Desk
office_desk_set_position:
  mode: restart
  fields:
    position:
      name: Position
      description: Position to set the desk to
      example: "50"
      selector:
        number:
          min: 10
          max: 100
          step: 1
  sequence:
    - repeat:
        until: >
          {{
            state_attr("cover.office_desk_esphome", "current_position") | int ==
            position | int
          }}
        sequence:
          - service: cover.set_cover_position
            data:
              entity_id: cover.office_desk_esphome
              position: >
                {{ position | int }}
          - wait_template: >
              {{ states("cover.office_desk_esphome") in ["opening", "closing"] }}
            timeout: '00:00:05'
          - wait_template: >
              {{ states("cover.office_desk_esphome") not in ["opening", "closing"] }}
            timeout: '00:00:10'

office_desk_sitting_mode:
  mode: single
  sequence:
    - service: script.turn_on
      data:
        entity_id: script.office_desk_set_position
        variables:
          position: "{{ states('input_number.office_desk_sitting_height') | int }}"

office_desk_standing_mode:
  mode: single
  sequence:
    - service: script.turn_on
      data:
        entity_id: script.office_desk_set_position
        variables:
          position: "{{ states('input_number.office_desk_standing_height') | int }}"
