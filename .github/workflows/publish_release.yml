---
name: Publish Release

on:
  pull_request:
    types:
      - closed
    branches:
      - main
      - master

jobs:
  cancel_if_not_merged:
    name: Cancel Workflow if Pull Request is not merged
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == false
    steps:
      - name: Cancel Workflow Run
        run: gh run cancel ${{ github.run_id }} --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  get-release-tag:
    name: Get Release Tag
    runs-on: ubuntu-latest
    outputs:
      release-tag: ${{ steps.get-tag.outputs.release-tag }}
    steps:
      - name: Get Release Tag
        id: get-tag
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
        run: |
          release_tag=$(echo "$BRANCH_NAME" | cut -d '/' -f2)

          if ! [[ $release_tag =~ ^[0-9]{1,2}\.[0-9]{1,4}\.[0-9]{1,4}$ ]]
          then
              echo "Release number is invalid: \`$release_tag\`" >> $GITHUB_STEP_SUMMARY
              exit 1
          fi

          echo "release-tag=$release_tag" >> $GITHUB_OUTPUT

  publish_release_notes:
    name: Publish Release Notes
    runs-on: ubuntu-latest
    needs:
      - get-release-tag
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
      deployments: write
      pages: write
    steps:
      - name: Point Release at `${{ github.base_ref }}`
        run: |
          gh release edit ${{ needs.get-release-tag.outputs.release-tag }} \
           --target ${{ github.base_ref }} \
           --repo ${{ github.repository }}

      - name: Publish Release Notes
        run: |
          gh release edit ${{ needs.get-release-tag.outputs.release-tag }} \
            --draft=false \
            --repo ${{ github.repository }}

      - name: Clone Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      - name: Merge Release Branch into `develop`
        run: |
          git checkout $GITHUB_HEAD_REF
          git checkout develop
          git merge $GITHUB_HEAD_REF --no-edit
          git push origin develop

      - name: Delete Release Branch
        run: 'git push origin --delete $GITHUB_HEAD_REF || :'
